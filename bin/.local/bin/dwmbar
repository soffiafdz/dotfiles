#!/bin/sh
# This script sets the statusbar with the xsetroot command at the end.

HOSTNAME="${HOSTNAME:-$(cat /etc/hostname)}"

# Handle SIGUSR1 to force immediate update (useful for resume from sleep)
trap 'update_now=1' USR1

for pid in $(pgrep -f dwmbar); do
  if [ "$pid" != "$$" ]; then
    kill "$pid"
  fi
done

sleep 1

# Exit if dwm isn't running
if ! pgrep dwm >/dev/null 2>&1; then
  echo "dwm not running"
  exit 1
fi

# Set delimeter
delim=""

# Here is the (big) function that outputs the appearance of the statusbar. It
# can really be broken down into many submodules which I've commented and
# explained.	Note that I use printf "%s" to format everything without line
# breaks. I try to put | as delimiters between modules.
status() {
  # Get current mpd track filename or artist - title if possible.
  # mpc -f "[[%artist% - [%title%]" 2>/dev/null | grep -v "volume:" | head -n 1 && echo "$delim"

  ### Volume
  case $HOSTNAME in
  *mcgill*)
    # Use PulseAudio on mcgill systems - get default sink info
    sink_info=$(timeout 2 pactl info 2>/dev/null | grep "Default Sink" | cut -d: -f2 | tr -d ' ')
    if [ -n "$sink_info" ]; then
      # Get mute status and volume from sink info
      sink_data=$(timeout 2 pactl list sinks 2>/dev/null | grep -A 15 "Name: $sink_info")
      mute=$(echo "$sink_data" | grep "Mute:" | awk '{print $2}')
      vol=$(echo "$sink_data" | grep "Volume:" | head -n1 | awk '{print $5}' | sed 's/%//')

      case $mute in
      "yes") echo "   $delim" ;;
      "no")
        case $vol in
        0) echo " $vol   $delim" ;;
        [0-9]% | [1-2][0-9]%) echo " $vol  $delim" ;;
        [3-6][0-9]%) echo " $vol  $delim" ;;
        [7-9][0-9]% | 1[0-9][0-9]%) echo " $vol   $delim" ;;
        esac
        ;;
      esac
    else
      # Fallback if we can't determine default sink
      echo "   $delim"
    fi
    ;;
  *)
    # Use pamixer on other systems
    mute=$(timeout 2 pamixer --get-mute 2>/dev/null)
    vol=$(timeout 2 pamixer --get-volume-human 2>/dev/null)
    case $mute in
    "true") echo "   $delim" ;;
    "false") case $vol in
      0%) echo " $vol   $delim" ;;
      [0-9]% | [1-2][0-9]%) echo " $vol  $delim" ;;
      [3-6][0-9]%) echo " $vol  $delim" ;;
      [7-9][0-9]% | 1[0-9][0-9]%) echo " $vol   $delim" ;;
      esac ;;
    esac
    ;;
  esac

  ### Internet
  # Ethernet up: wired icon; else wifi signal or disconnected
  # Old comment:  icon if ethernet is connected.
  # Make if for when there is no network
  eth_up=0
  for f in /sys/class/net/e*/operstate; do
    [ -f "$f" ] && [ "$(cat "$f")" = "up" ] && eth_up=1 && break
  done

  if [ "$eth_up" = "1" ]; then
    echo "󰈁 $delim"
  else
    wifi=$(grep "^\s*w" /proc/net/wireless | awk '{ print int($3 * 100 / 70) "%"}')
    [ -z "$wifi" ] && echo "󰖪 $delim" || echo "$wifi 󰖩 $delim"
  fi

  ### Disk
  # Disk space available (use timeout for network mounts)
  df_out=$(timeout 3 df -h 2>/dev/null)
  case $HOSTNAME in
  "janus")
    disk=$(echo "$df_out" | awk '/^\/dev\/nvme0n1p5/ {print $5}' | tr -d '%')
    disk2=$(echo "$df_out" | awk '/^\/dev\/nvme0n1p7/ {print $5}' | tr -d '%')
    disk3=$(echo "$df_out" | awk '/^\/dev\/sda2/ {print $5}' | tr -d '%')
    ;;
  "lettera")
    disk=$(echo "$df_out" | awk '/^\/dev\/sda1/ {print $5}' | tr -d '%')
    disk2=$(echo "$df_out" | awk '/^\/dev\/sda3/ {print $5}' | tr -d '%')
    ;;
  "tango")
    disk=$(echo "$df_out" | awk '/^\/dev\/nvme0n1p2/ {print $5}' | tr -d '%')
    disk2=$(echo "$df_out" | awk '/^\/dev\/nvme0n1p3/ {print $5}' | tr -d '%')
    ;;
  *mcgill*)
    # Add mcgill system disk configuration here if needed
    disk=$(echo "$df_out" | awk '/^home:\/home/ {print $5}' | tr -d '%')
    ;;
  *)
    # Default/unknown system
    disk=""
    disk2=""
    ;;
  esac

  # Only echo if we have disk info
  disk_str=""
  [ -n "$disk" ] && disk_str="/$disk"
  [ -n "$disk2" ] && disk_str="$disk_str|~$disk2"
  [ -n "$disk3" ] && disk_str="$disk_str|V$disk3"
  disk_str="${disk_str#|}"
  [ -n "$disk_str" ] && echo "$disk_str 󰋊 $delim"

  ### Memory
  # Memory used/total
  timeout 2 free -h 2>/dev/null | awk '/^Mem:/ {print $3}'
  echo " $delim"

  ### CPU temp
  case $HOSTNAME in
  "janus")
    temp=$(timeout 2 sensors 2>/dev/null | awk '/^Tctl:/ {print $2}' | sed -e "s/+//; s/C//")
    ;;
  "lettera")
    temp=$(timeout 2 sensors 2>/dev/null | awk '/^temp1:/ {print $2}' | sed -e "s/+//; s/C//")
    ;;
  *mcgill*)
    # Add mcgill system temperature sensor here if needed
    temp=$(timeout 2 sensors 2>/dev/null | awk '/^Tctl:/ {print $2}' | sed -e "s/+//; s/C//")
    ;;
  *)
    temp=$(timeout 2 sensors 2>/dev/null | awk '/skylake/ {getline; getline; print $2}' | sed -e "s/+//; s/C//")
    ;;
  esac
  if [ -n "$temp" ]; then
    echo "$temp󰔄 $delim"
  fi

  ### Battery
  # Will show battery with approximate icon for remaining power.
  if [ -f "/sys/class/power_supply/BAT0/capacity" ] &&
    [ -f "/sys/class/power_supply/BAT0/status" ]; then
    batt=$(cat /sys/class/power_supply/BAT0/capacity)
    bstat=$(cat /sys/class/power_supply/BAT0/status)
    case $batt in
    9[5-9] | 1[0-2][0-9]) bcap=" " ;;
    8[5-9] | 9[0-4]) bcap=" " ;;
    7[5-9] | 8[0-4]) bcap=" " ;;
    6[5-9] | 7[0-4]) bcap=" " ;;
    5[5-9] | 6[0-4]) bcap=" " ;;
    4[5-9] | 5[0-4]) bcap=" " ;;
    3[5-9] | 4[0-4]) bcap=" " ;;
    2[5-9] | 3[0-4]) bcap=" " ;;
    1[5-9] | 2[0-4]) bcap=" " ;;
    [5-9] | 1[0-4]) bcap=" " ;;
    [0-5]) bcap=" " ;;
    *) : ;;
    esac

    # Only print if bcap is set (battery icon found)
    if [ -n "$bcap" ]; then
      if [ "$bstat" = "Charging" ]; then
        echo "$bcap" | awk -v batt="$batt% " -v delim=" $delim" '{print batt $2 delim}'
      elif [ "$bstat" = "Discharging" ] || [ "$bstat" = "Full" ] || [ "$bstat" = "Unknown" ]; then
        echo "$bcap" | awk -v batt="$batt% " -v delim=" $delim" '{print batt $1 delim}'
      fi
    fi
  fi

  ### TIME
  time=$(date '+%H:%M')
  hr=$(date '+%I')
  case $hr in
  01) echo "$time 󱐿 $delim" ;;
  02) echo "$time 󱑀 $delim" ;;
  03) echo "$time 󱑁 $delim" ;;
  04) echo "$time 󱑂 $delim" ;;
  05) echo "$time 󱑃 $delim" ;;
  06) echo "$time 󱑄 $delim" ;;
  07) echo "$time 󱑅 $delim" ;;
  08) echo "$time 󱑆 $delim" ;;
  09) echo "$time 󱑇 $delim" ;;
  10) echo "$time 󱑈 $delim" ;;
  11) echo "$time 󱑉 $delim" ;;
  12) echo "$time 󱑊 $delim" ;;
  esac

  ### Date
  echo "$(date '+%y:%m:%d') "
}

while pgrep dwm >/dev/null 2>&1; do
  xsetroot -name "$(status | tr '\n' ' ')"
  sleep 5s
done
